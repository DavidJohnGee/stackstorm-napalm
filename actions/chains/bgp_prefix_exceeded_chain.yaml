---
    chain:
        -
            name: "get_bgp_neighbours"
            ref: "napalm.get_bgp_neighbors"
            parameters:
                hostname: {{hostname}}
                credentials: "public"
            publish:
              neighbourdetails: {{get_bgp_neighbours.result.global.peers[neighbour]}}
              stderr: {{get_bgp_neighbors.stderr}}
            on-success: "send_show_bgp_neighbours_to_slack"
            on-failure: "report_failure"
        -
            name: "show_route"
            ref: "napalm.routeto"
            parameters:
                hostname: {{hostname}}
                destination: {{neighbour}}
                credentials: "public"
            publish:
              stderr: {{show_route.stderr}}
            on-success: "send_email"
            on-failure: "report_failure"
        -
            name: "send_email"
            ref: "core.sendmail"
            parameters:
              to: "rob.woodward@colt.net"
              from: "stackstorm@colt.net"
              subject: "BGP neighbour <% $.neighbour %> exceeded prefix limit on <% $.hostname %>."
              body:  "{{message}}\r\n
                      Neighbour details\r\n
                      Description: {{neighbourdetails.description}}\r\n
                      AS Number: {{neighbourdetails.remote_as}}\r\n
                      Sent Prefixes: {{neighbourdetails.address_family.ipv4.sent_prefixes}}\r\n
                      Accepted Routes: {{neighbourdetails.address_family.ipv4.accepted_prefixes}}\r\n
                      Received Routes: {{neighbourdetails.address_family.ipv4.received_prefixes}}\r\n
                      {{show_route.result | to_json_string}}"
        -
            name: "report_failure"
            ref: "core.sendmail"
            parameters:
              to: "rob.woodward@colt.net"
              from: "stackstorm@colt.net"
              subject: "Stackstorm BGP prefix exceeded workflow error"
              body:  "Something went wrong with the BGP neighbour prefix exceeded workflow.\r\n\r\n<% $.stderr %>"
    default: "get_bgp_neighbours"
