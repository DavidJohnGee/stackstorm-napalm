---
    chain:
        -
            name: "show_bgp_neighbours"
            ref: "napalm.get_bgp_neighbors"
            parameters:
                hostname: "{{ hostname }}"
                credentials: "public"
            publish:
              neighbourdetails: "{{ show_bgp_neighbours.result.global.peers.get(neighbour) }}"
              stderr: "{{ show_bgp_neighbours.stderr }}"
            on-success: "show_route"
            on-failure: "report_failure"
        -
            name: "show_route"
            ref: "napalm.routeto"
            parameters:
                hostname: "{{ hostname }}"
                destination: "{{ neighbour }}"
                credentials: "public"
            publish:
              stderr: "{{ show_route.stderr }}"
            on-success: "show_log"
            on-failure: "report_failure"
        -
            name: "show_log"
            ref: "napalm.run_cmd"
            parameters:
                hostname: "{{ hostname }}"
                command: "show log"
                credentials: "public"
            publish:
              stderr: "{{ show_route.stderr }}"
            on-success: "send_email"
            on-failure: "report_failure"
        -
            name: "send_email"
            ref: "core.sendmail"
            parameters:
              to: "rob.woodward@colt.net"
              from: "stackstorm@colt.net"
              subject: "BGP neighbour <% $.neighbour %> exceeded prefix limit on <% $.hostname %>."
              content_type: "text/plain"
              body:  "{{ message }}\r\n\r\n
                      {{ neighbourdetails | to_json_string }}\r\n\r\n
                      {{ show_route.result | to_json_string }}\r\n\r\n
                      {{ show_log.result }}\r\n\r\n"
        -
            name: "report_failure"
            ref: "core.sendmail"
            parameters:
              to: "rob.woodward@colt.net"
              from: "stackstorm@colt.net"
              subject: "Stackstorm BGP prefix exceeded workflow error"
              body:  "Something went wrong with the BGP neighbour prefix exceeded workflow.\r\n\r\n {{ stderr }}"
    default: "show_bgp_neighbours"
