---
version: '2.0'

napalm.bgp_prefix_exceeded_workflow:

  input:
    - hostname
    - message
    - neighbour
    - asnum
    - prefixes
  tasks:

    show_bgp_neighbours:
      action: napalm.get_bgp_neighbors
      input:
        hostname: <% $.hostname %>
        credentials: "public"
      publish:
        neighbourdetails: <% task(show_bgp_neighbours).result.result.global.peers.get($.neighbour) %>
      on-success:
        - show_route
      on-error:
        - report_failure

    show_route:
      action: napalm.routeto
      input:
        hostname: <% $.hostname %>
        destination: <% $.neighbour %>
        credentials: "public"
      on-success:
        - send_email
      on-error:
        - report_failure

    send_email:
      action: core.sendmail
      input:
        to: "rob.woodward@colt.net"
        from: "stackstorm@colt.net"
        subject: "BGP neighbour <% $.neighbour %> exceeded prefix limit on <% $.hostname %>."
        body:  "<% $.message %>\r\n<% $.neighbourdetails %>\r\n<% task(show_route).result.result %>"
      on-error:
        - report_failure

    report_failure:
      action: core.sendmail
      input:
        to: "rob.woodward@colt.net"
        from: "stackstorm@colt.net"
        subject: "Stackstorm Workflow Error"
        body:  "Something went wrong with the BGP neighbour prefix exceeded workflow."
