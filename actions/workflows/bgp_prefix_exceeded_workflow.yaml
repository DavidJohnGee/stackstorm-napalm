---
  version: '2.0'

  napalm.bgp_prefix_exceeded_workflow:

    input:
      - hostname
      - message
      - neighbour
      - asnum
      - prefixes

    type: direct

    task-defaults:
      on-error:
        - notify_on_error

    tasks:
      show_bgp_neighbours:
        action: napalm.get_bgp_neighbors
        input:
          hostname: <% $.hostname %>
          credentials: "public"
        publish:
          neighbourdetails: <% task(show_bgp_neighbours).result.result.global.peers.get($.neighbour) %>
          stderr: <% task(show_bgp_neighbours).result.stderr %>
        on-success:
          - show_route

      show_route:
        action: napalm.routeto
        input:
          hostname: <% $.hostname %>
          destination: <% $.neighbour %>
          credentials: "public"
        publish:
          stderr: <% task(show_route).result.stderr %>
        on-success:
          - send_email

      send_email:
        action: core.sendmail
        input:
          to: "rob.woodward@colt.net"
          from: "stackstorm@colt.net"
          subject: "BGP neighbour <% $.neighbour %> exceeded prefix limit on <% $.hostname %>."
          body:  "<% $.message %>\r\n
                  Neighbour details\r\n
                  Description: <% $.neighbourdetails.description %>\r\n
                  AS Number: <% $.neighbourdetails.remote_as %>\r\n
                  Sent Prefixes: <% $.neighbourdetails.address_family.ipv4.sent_prefixes %>\r\n
                  Accepted Routes: <% $.neighbourdetails.address_family.ipv4.accepted_prefixes %>\r\n
                  Received Routes: <% $.neighbourdetails.address_family.ipv4.received_prefixes %>\r\n
                  <% task(show_route).result.result %>"
        publish:
          stderr: <% task(send_email).result.stderr %>

      notify_on_error:
        action: core.sendmail
        input:
          to: "rob.woodward@colt.net"
          from: "stackstorm@colt.net"
          subject: "Stackstorm BGP prefix exceeded workflow error"
          body:  "Something went wrong with the BGP neighbour prefix exceeded workflow.\r\n\r\n<% $.stderr %>"
        on-complete:
          - fail
